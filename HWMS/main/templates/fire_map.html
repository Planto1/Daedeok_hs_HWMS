<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ í™”ì¬ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { width: 100%; height: 100vh; }
        .fade-out {
            animation: fadeOut 1s ease-in-out forwards;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }
    </style>
</head>
<body class="m-0 p-0 font-sans overflow-hidden">
    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” - í†µê³„ (ì´ì „ê³¼ ë™ì¼) -->
    <div id="leftSidebar" class="fixed left-0 top-0 h-full w-96 bg-white shadow-xl transform transition-transform duration-300 z-20 overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center gap-3 mb-6">
                <span class="text-3xl">ğŸ”¥</span>
                <h1 class="text-2xl font-bold text-gray-800">í™”ì¬ í†µê³„</h1>
            </div>

            <button onclick="loadFireData()" id="refreshBtn" class="w-full flex items-center justify-center gap-2 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white px-4 py-3 rounded-lg transition-colors mb-4">
                <span id="refreshIcon">ğŸ”„</span>
                <span id="refreshText">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</span>
            </button>

            <div id="lastUpdate" class="hidden flex items-center gap-2 text-sm text-gray-600 mb-6 bg-gray-50 p-3 rounded-lg">
                <span>ğŸ•</span>
                <span id="updateTime"></span>
            </div>

            <div class="mb-6">
                <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
                    <span>ğŸ“Š</span> í™”ì¬ í†µê³„
                </h2>
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-700">ì´ ê°ì§€</span>
                        <span id="totalCount" class="font-bold text-xl text-gray-900">0</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                        <span class="text-purple-700">í´ëŸ¬ìŠ¤í„°</span>
                        <span id="clusterCount" class="font-bold text-xl text-purple-600">0</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                        <span class="text-red-700">ë†’ì€ ì‹ ë¢°ë„</span>
                        <span id="highCount" class="font-bold text-xl text-red-600">0</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg">
                        <span class="text-orange-700">ë³´í†µ ì‹ ë¢°ë„</span>
                        <span id="nominalCount" class="font-bold text-xl text-orange-600">0</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                        <span class="text-yellow-700">ë‚®ì€ ì‹ ë¢°ë„</span>
                        <span id="lowCount" class="font-bold text-xl text-yellow-600">0</span>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="font-semibold mb-3">ì‹ ë¢°ë„ ë²”ë¡€</h3>
                <div class="space-y-2">
                    <div class="flex items-center gap-3">
                        <div class="w-5 h-5 rounded-full bg-red-500"></div>
                        <span class="text-sm text-gray-700">ë†’ìŒ (h)</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-5 h-5 rounded-full bg-orange-500"></div>
                        <span class="text-sm text-gray-700">ë³´í†µ (n)</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-5 h-5 rounded-full bg-yellow-500"></div>
                        <span class="text-sm text-gray-700">ë‚®ìŒ (l)</span>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="font-semibold mb-3 flex items-center gap-2">
                    <span>ğŸ“</span> í™”ì¬ í´ëŸ¬ìŠ¤í„° (<span id="clusterListCount">0</span>)
                </h3>
                <div id="clusterList" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
        
        <button id="toggleLeftSidebar" class="absolute right-0 top-1/2 transform translate-x-full -translate-y-1/2 bg-white shadow-lg rounded-r-lg px-2 py-8 hover:bg-gray-50 transition-colors">
            <span id="leftArrowIcon" class="text-xl font-bold text-gray-600">â—€</span>
        </button>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” - ë‚ ì§œ ê²€ìƒ‰ -->
    <div id="rightSidebar" class="fixed right-0 top-0 h-full w-96 bg-white shadow-xl transform transition-transform duration-300 z-20 overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center gap-3 mb-6">
                <span class="text-3xl">ğŸ“…</span>
                <h1 class="text-2xl font-bold text-gray-800">ê¸°ê°„ ê²€ìƒ‰</h1>
            </div>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ì‹œì‘ ë‚ ì§œ</label>
                    <input type="date" id="startDate" value="2025-12-17" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ì¢…ë£Œ ë‚ ì§œ</label>
                    <input type="date" id="endDate" value="2025-12-19" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <button onclick="handleDateSearch()" class="w-full flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg transition-colors">
                    <span>ğŸ”</span> DBì—ì„œ ê²€ìƒ‰
                </button>
                
                <!-- ìƒˆë¡œìš´ ê¸°ëŠ¥: FIRMSì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° -->
                <button onclick="fetchAndSaveData()" id="fetchBtn" class="w-full flex items-center justify-center gap-2 bg-purple-500 hover:bg-purple-600 disabled:bg-gray-400 text-white px-4 py-3 rounded-lg transition-colors">
                    <span id="fetchIcon">ğŸ“¥</span>
                    <span id="fetchText">FIRMSì—ì„œ ê°€ì ¸ì˜¤ê¸°</span>
                </button>
                
                <div class="text-xs text-gray-500 bg-yellow-50 p-3 rounded">
                    ğŸ’¡ DBì— ì—†ëŠ” ë‚ ì§œëŠ” "FIRMSì—ì„œ ê°€ì ¸ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì—¬ ë°ì´í„°ë¥¼ ë¨¼ì € ê°€ì ¸ì™€ì£¼ì„¸ìš”.
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-lg mb-6">
                <h3 class="font-semibold mb-2 text-blue-900">ê²€ìƒ‰ ì¡°ê±´</h3>
                <div class="text-sm text-blue-800 space-y-1">
                    <div>ê¸°ê°„: <span id="searchPeriod">-</span></div>
                    <div>ì¼ìˆ˜: <span id="searchDays">-</span>ì¼</div>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="font-semibold mb-3">ë¹ ë¥¸ ì„ íƒ</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setQuickDate(0)" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm transition-colors">ì˜¤ëŠ˜</button>
                    <button onclick="setQuickDate(1)" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm transition-colors">ìµœê·¼ 2ì¼</button>
                    <button onclick="setQuickDate(6)" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm transition-colors">ìµœê·¼ 7ì¼</button>
                    <button onclick="setQuickDate(29)" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm transition-colors">ìµœê·¼ 30ì¼</button>
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-semibold mb-2">ê²€ìƒ‰ ê²°ê³¼</h3>
                <div class="text-sm text-gray-700 space-y-2">
                    <div class="flex justify-between">
                        <span>ì´ í™”ì¬:</span>
                        <span id="resultTotal" class="font-bold">0ê±´</span>
                    </div>
                    <div class="flex justify-between">
                        <span>í´ëŸ¬ìŠ¤í„°:</span>
                        <span id="resultCluster" class="font-bold">0ê°œ</span>
                    </div>
                    <div class="flex justify-between">
                        <span>ì¼í‰ê· :</span>
                        <span id="resultAvg" class="font-bold">0ê±´/ì¼</span>
                    </div>
                </div>
            </div>
        </div>
        
        <button id="toggleRightSidebar" class="absolute left-0 top-1/2 transform -translate-x-full -translate-y-1/2 bg-white shadow-lg rounded-l-lg px-2 py-8 hover:bg-gray-50 transition-colors">
            <span id="rightArrowIcon" class="text-xl font-bold text-gray-600">â–¶</span>
        </button>
    </div>

    <!-- ë©”ì¸ ì§€ë„ -->
    <div id="mapContainer" style="margin-left: 384px; margin-right: 384px; transition: all 0.3s;">
        <div id="map"></div>
    </div>

    <!-- ìƒë‹¨ ì •ë³´ íŒ¨ë„ (10ì´ˆ í›„ ìë™ ìˆ¨ê¹€) -->
    <div id="infoPanel" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-white p-4 rounded-lg shadow-lg z-10">
        <div class="flex items-center gap-2 mb-2">
            <span>â„¹ï¸</span>
            <span class="font-semibold">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</span>
        </div>
        <div class="text-sm text-gray-600 text-center">
            <div>ë°ì´í„° ì†ŒìŠ¤: FIRMS VIIRS NOAA-20</div>
            <div>í´ëŸ¬ìŠ¤í„° ë°˜ê²½: 10km</div>
            <div class="text-xs text-gray-400 mt-1">ì´ ë©”ì‹œì§€ëŠ” 10ì´ˆ í›„ ì‚¬ë¼ì§‘ë‹ˆë‹¤</div>
        </div>
    </div>

    <script>
        let map;
        let allFires = [];
        let clusters = [];
        let clusterMarkers = [];
        let currentInfoWindow = null;
        let infoPanelTimeout = null;
        
        // ì‚¬ì´ë“œë°” í† ê¸€ (ì´ì „ê³¼ ë™ì¼)
        const leftSidebar = document.getElementById('leftSidebar');
        const rightSidebar = document.getElementById('rightSidebar');
        const mapContainer = document.getElementById('mapContainer');
        const toggleLeft = document.getElementById('toggleLeftSidebar');
        const toggleRight = document.getElementById('toggleRightSidebar');
        const leftArrow = document.getElementById('leftArrowIcon');
        const rightArrow = document.getElementById('rightArrowIcon');
        
        let leftOpen = true;
        let rightOpen = true;
        
        toggleLeft.addEventListener('click', () => {
            leftOpen = !leftOpen;
            if (leftOpen) {
                leftSidebar.classList.remove('-translate-x-full');
                leftArrow.textContent = 'â—€';
                mapContainer.style.marginLeft = '384px';
            } else {
                leftSidebar.classList.add('-translate-x-full');
                leftArrow.textContent = 'â–¶';
                mapContainer.style.marginLeft = '0';
            }
        });
        
        toggleRight.addEventListener('click', () => {
            rightOpen = !rightOpen;
            if (rightOpen) {
                rightSidebar.classList.remove('translate-x-full');
                rightArrow.textContent = 'â–¶';
                mapContainer.style.marginRight = '384px';
            } else {
                rightSidebar.classList.add('translate-x-full');
                rightArrow.textContent = 'â—€';
                mapContainer.style.marginRight = '0';
            }
        });

        // ì •ë³´ íŒ¨ë„ ìë™ ìˆ¨ê¹€ í•¨ìˆ˜
        function hideInfoPanelAfterDelay() {
            const infoPanel = document.getElementById('infoPanel');
            
            // ê¸°ì¡´ íƒ€ì´ë¨¸ í´ë¦¬ì–´
            if (infoPanelTimeout) {
                clearTimeout(infoPanelTimeout);
            }
            
            // 10ì´ˆ í›„ ì‚¬ë¼ì§€ë„ë¡ ì„¤ì •
            infoPanelTimeout = setTimeout(() => {
                infoPanel.classList.add('fade-out');
            }, 10000);
        }

        // êµ¬ê¸€ë§µ ì´ˆê¸°í™”
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 36.5, lng: 127.5 },
                zoom: 7,
                mapTypeId: 'terrain'
            });
            
            loadFireData();
            hideInfoPanelAfterDelay();  // í˜ì´ì§€ ë¡œë“œ ì‹œ íƒ€ì´ë¨¸ ì‹œì‘
        }

        // ê±°ë¦¬ ê³„ì‚° (km) - ì´ì „ê³¼ ë™ì¼
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // í™”ì¬ í´ëŸ¬ìŠ¤í„°ë§ (10km ì´ë‚´) - ì´ì „ê³¼ ë™ì¼
        function clusterFires(fireData) {
            const clustered = [];
            const processed = new Set();
            const clusterRadius = 10;

            fireData.forEach((fire, index) => {
                if (processed.has(index)) return;

                const cluster = {
                    fires: [fire],
                    centerLat: fire.latitude,
                    centerLng: fire.longitude,
                    maxConfidence: fire.confidence
                };

                fireData.forEach((otherFire, otherIndex) => {
                    if (index === otherIndex || processed.has(otherIndex)) return;
                    
                    const distance = calculateDistance(
                        fire.latitude, fire.longitude,
                        otherFire.latitude, otherFire.longitude
                    );

                    if (distance <= clusterRadius) {
                        cluster.fires.push(otherFire);
                        processed.add(otherIndex);
                        
                        cluster.centerLat = cluster.fires.reduce((sum, f) => sum + f.latitude, 0) / cluster.fires.length;
                        cluster.centerLng = cluster.fires.reduce((sum, f) => sum + f.longitude, 0) / cluster.fires.length;
                        
                        if (otherFire.confidence === 'h' || 
                            (otherFire.confidence === 'n' && cluster.maxConfidence === 'l')) {
                            cluster.maxConfidence = otherFire.confidence;
                        }
                    }
                });

                processed.add(index);
                clustered.push(cluster);
            });

            return clustered;
        }

        // í™”ì¬ ë°ì´í„° ë¡œë“œ (DBì—ì„œ)
        function loadFireData() {
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            const refreshText = document.getElementById('refreshText');
            
            refreshBtn.disabled = true;
            refreshIcon.textContent = 'â³';
            refreshText.textContent = 'ë¡œë”© ì¤‘...';
            
            clearMarkers();
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let url = '/api/fire-data/';
            if (startDate && endDate) {
                url += `?start_date=${startDate}&end_date=${endDate}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('í™”ì¬ ë°ì´í„° ë¡œë“œ:', data.length + 'ê°œ');
                    
                    allFires = data;
                    clusters = clusterFires(data);
                    
                    displayClusters();
                    updateStatistics(data, clusters);
                    updateClusterList(clusters);
                    updateSearchResults(data, clusters, startDate, endDate);
                    
                    document.getElementById('updateTime').textContent = 
                        `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR')}`;
                    document.getElementById('lastUpdate').classList.remove('hidden');
                    
                    refreshBtn.disabled = false;
                    refreshIcon.textContent = 'ğŸ”„';
                    refreshText.textContent = 'ë°ì´í„° ìƒˆë¡œê³ ì¹¨';
                    
                    // ì •ë³´ íŒ¨ë„ ë‹¤ì‹œ í‘œì‹œí•˜ê³  10ì´ˆ í›„ ìˆ¨ê¹€
                    const infoPanel = document.getElementById('infoPanel');
                    infoPanel.classList.remove('fade-out');
                    infoPanel.style.opacity = '1';
                    infoPanel.style.visibility = 'visible';
                    hideInfoPanelAfterDelay();
                })
                .catch(error => {
                    console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert('í™”ì¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    
                    refreshBtn.disabled = false;
                    refreshIcon.textContent = 'ğŸ”„';
                    refreshText.textContent = 'ë°ì´í„° ìƒˆë¡œê³ ì¹¨';
                });
        }

        // FIRMS APIì—ì„œ ë°ì´í„° ê°€ì ¸ì™€ì„œ DBì— ì €ì¥
        // FIRMS APIì—ì„œ ë°ì´í„° ê°€ì ¸ì™€ì„œ DBì— ì €ì¥ (ê°œì„  ë²„ì „)
        function fetchAndSaveData() {
            const fetchBtn = document.getElementById('fetchBtn');
            const fetchIcon = document.getElementById('fetchIcon');
            const fetchText = document.getElementById('fetchText');
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            console.log('=== fetchAndSaveData ì‹œì‘ ===');
            console.log('ì‹œì‘ ë‚ ì§œ:', startDate);
            console.log('ì¢…ë£Œ ë‚ ì§œ:', endDate);
            
            if (!startDate || !endDate) {
                alert('ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (startDate > endDate) {
                alert('ì‹œì‘ ë‚ ì§œê°€ ì¢…ë£Œ ë‚ ì§œë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const daysDiff = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
            
            if (daysDiff > 30) {
                alert('ìµœëŒ€ 30ì¼ê¹Œì§€ë§Œ ì¡°íšŒ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm(`${startDate} ~ ${endDate} (${daysDiff}ì¼)ì˜ ë°ì´í„°ë¥¼ FIRMS APIì—ì„œ ê°€ì ¸ì™€ DBì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‹œê°„ì´ ë‹¤ì†Œ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)) {
                return;
            }
            
            fetchBtn.disabled = true;
            fetchIcon.textContent = 'â³';
            fetchText.textContent = 'ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
            
            const requestData = {
                start_date: startDate,
                end_date: endDate
            };
            
            console.log('ìš”ì²­ ë°ì´í„°:', requestData);
            console.log('ìš”ì²­ URL:', '/api/fetch-save/');
            
            fetch('/api/fetch-save/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                console.log('ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
                
                // ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ ë¨¼ì € ì½ê¸°
                return response.text().then(text => {
                    console.log('ì‘ë‹µ ë³¸ë¬¸ (raw):', text);
                    
                    try {
                        const data = JSON.parse(text);
                        if (!response.ok) {
                            throw new Error(data.message || `ì„œë²„ ì˜¤ë¥˜ (${response.status})`);
                        }
                        return data;
                    } catch (e) {
                        console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', e);
                        console.error('ì‘ë‹µ ë‚´ìš©:', text);
                        throw new Error(`ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ${e.message}`);
                    }
                });
            })
            .then(data => {
                console.log('ì„±ê³µ ì‘ë‹µ:', data);
                
                if (data.status === 'success') {
                    alert(`âœ… ì„±ê³µ!\n\n${data.message}\nê¸°ê°„: ${data.start_date} ~ ${data.end_date}`);
                    loadFireData();
                } else {
                    alert(`âŒ ì‹¤íŒ¨\n\n${data.message}`);
                }
                
                fetchBtn.disabled = false;
                fetchIcon.textContent = 'ğŸ“¥';
                fetchText.textContent = 'FIRMSì—ì„œ ê°€ì ¸ì˜¤ê¸°';
            })
            .catch(error => {
                console.error('=== ì˜¤ë¥˜ ë°œìƒ ===');
                console.error('ì˜¤ë¥˜ íƒ€ì…:', error.name);
                console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
                console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
                
                alert(`âŒ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n${error.message}\n\nìì„¸í•œ ë‚´ìš©ì€ ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                
                fetchBtn.disabled = false;
                fetchIcon.textContent = 'ğŸ“¥';
                fetchText.textContent = 'FIRMSì—ì„œ ê°€ì ¸ì˜¤ê¸°';
            });
        }

        // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        function clearMarkers() {
            clusterMarkers.forEach(marker => marker.setMap(null));
            clusterMarkers = [];
            if (currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }
        }

        // í´ëŸ¬ìŠ¤í„° í‘œì‹œ
        function displayClusters() {
            clusters.forEach((cluster, index) => {
                const fillColor = 
                    cluster.maxConfidence === 'h' ? '#FF0000' :
                    cluster.maxConfidence === 'n' ? '#FF6B00' : '#FFD700';
                
                const clusterSize = Math.max(30, Math.min(cluster.fires.length * 8, 50));
                
                const marker = new google.maps.Marker({
                    position: { lat: cluster.centerLat, lng: cluster.centerLng },
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: fillColor,
                        fillOpacity: 0.9,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 3,
                        scale: clusterSize
                    },
                    label: {
                        text: cluster.fires.length.toString(),
                        color: '#FFFFFF',
                        fontSize: '14px',
                        fontWeight: 'bold'
                    },
                    title: `í´ëŸ¬ìŠ¤í„° #${index + 1} - ${cluster.fires.length}ê±´`,
                    zIndex: cluster.maxConfidence === 'h' ? 1000 : 100
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: createClusterInfoContent(cluster, index)
                });
                
                marker.addListener('click', () => {
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }
                    infoWindow.open(map, marker);
                    currentInfoWindow = infoWindow;
                    map.setCenter(marker.getPosition());
                    map.setZoom(10);
                });
                
                clusterMarkers.push(marker);
            });
        }

        // í´ëŸ¬ìŠ¤í„° ì •ë³´ì°½ HTML ìƒì„±
        function createClusterInfoContent(cluster, index) {
            const confidenceText = c => c === 'h' ? 'ë†’ìŒ' : c === 'n' ? 'ë³´í†µ' : 'ë‚®ìŒ';
            const confidenceColor = c => c === 'h' ? 'bg-red-500' : c === 'n' ? 'bg-orange-500' : 'bg-yellow-500';
            
            let tableRows = '';
            cluster.fires.forEach((fire, fIndex) => {
                tableRows += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-2 py-2 border">${fIndex + 1}</td>
                        <td class="px-2 py-2 border">${fire.acq_date}</td>
                        <td class="px-2 py-2 border">${fire.acq_time}</td>
                        <td class="px-2 py-2 border text-right font-semibold">${fire.frp}</td>
                        <td class="px-2 py-2 border text-right">${fire.bright_ti4}K</td>
                        <td class="px-2 py-2 border text-center">
                            <span class="px-2 py-1 rounded text-white text-xs font-semibold ${confidenceColor(fire.confidence)}">
                                ${confidenceText(fire.confidence)}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            const avgFrp = (cluster.fires.reduce((sum, f) => sum + f.frp, 0) / cluster.fires.length).toFixed(1);
            const maxFrp = Math.max(...cluster.fires.map(f => f.frp)).toFixed(1);
            const avgTemp = (cluster.fires.reduce((sum, f) => sum + f.bright_ti4, 0) / cluster.fires.length).toFixed(1);
            const satellites = [...new Set(cluster.fires.map(f => f.satellite))].join(', ');
            
            return `
                <div style="max-width: 500px; font-family: sans-serif;">
                    <h4 style="font-weight: bold; font-size: 1.125rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb;">
                        ğŸ”¥ í´ëŸ¬ìŠ¤í„° #${index + 1} - ${cluster.fires.length}ê±´ì˜ í™”ì¬
                    </h4>
                    
                    <div style="max-height: 300px; overflow-y: auto; margin-bottom: 0.75rem;">
                        <table style="width: 100%; font-size: 0.75rem; border-collapse: collapse;">
                            <thead style="background: #f3f4f6; position: sticky; top: 0;">
                                <tr>
                                    <th class="px-2 py-2 border">ë²ˆí˜¸</th>
                                    <th class="px-2 py-2 border">ë‚ ì§œ</th>
                                    <th class="px-2 py-2 border">ì‹œê°„</th>
                                    <th class="px-2 py-2 border">FRP</th>
                                    <th class="px-2 py-2 border">ì˜¨ë„</th>
                                    <th class="px-2 py-2 border">ì‹ ë¢°ë„</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.75rem;">
                        <div style="background: #dbeafe; padding: 0.5rem; border-radius: 0.25rem;">
                            <div style="color: #1e40af;">í‰ê·  FRP</div>
                            <div style="font-weight: bold; color: #1e3a8a;">${avgFrp} MW</div>
                        </div>
                        <div style="background: #dcfce7; padding: 0.5rem; border-radius: 0.25rem;">
                            <div style="color: #15803d;">ìµœëŒ€ FRP</div>
                            <div style="font-weight: bold; color: #14532d;">${maxFrp} MW</div>
                        </div>
                        <div style="background: #f3e8ff; padding: 0.5rem; border-radius: 0.25rem;">
                            <div style="color: #7c3aed;">í‰ê·  ì˜¨ë„</div>
                            <div style="font-weight: bold; color: #5b21b6;">${avgTemp}K</div>
                        </div>
                        <div style="background: #fed7aa; padding: 0.5rem; border-radius: 0.25rem;">
                            <div style="color: #c2410c;">ìœ„ì„±</div>
                            <div style="font-weight: bold; color: #7c2d12;">${satellites}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics(fires, clusters) {
            const high = fires.filter(f => f.confidence === 'h').length;
            const nominal = fires.filter(f => f.confidence === 'n').length;
            const low = fires.filter(f => f.confidence === 'l').length;
            
            document.getElementById('totalCount').textContent = fires.length;
            document.getElementById('clusterCount').textContent = clusters.length;
            document.getElementById('highCount').textContent = high;
            document.getElementById('nominalCount').textContent = nominal;
            document.getElementById('lowCount').textContent = low;
        }

        // í´ëŸ¬ìŠ¤í„° ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateClusterList(clusters) {
            const clusterList = document.getElementById('clusterList');
            const clusterListCount = document.getElementById('clusterListCount');
            
            clusterListCount.textContent = clusters.length;
            
            if (clusters.length === 0) {
                clusterList.innerHTML = '<p class="text-gray-500 text-sm">ê°ì§€ëœ í´ëŸ¬ìŠ¤í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            clusterList.innerHTML = clusters.map((cluster, index) => {
                const bgColor = 
                    cluster.maxConfidence === 'h' ? 'bg-red-500' :
                    cluster.maxConfidence === 'n' ? 'bg-orange-500' : 'bg-yellow-500';
                
                const avgFrp = (cluster.fires.reduce((sum, f) => sum + f.frp, 0) / cluster.fires.length).toFixed(1);
                
                return `
                    <div 
                        class="p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all"
                        onclick="focusOnCluster(${index})"
                    >
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full ${bgColor}"></div>
                                <span class="font-semibold text-sm">í´ëŸ¬ìŠ¤í„° #${index + 1}</span>
                            </div>
                            <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">
                                ${cluster.fires.length}ê±´
                            </span>
                        </div>
                        <div class="text-xs text-gray-600 space-y-1">
                            <div>ì¤‘ì‹¬: ${cluster.centerLat.toFixed(4)}, ${cluster.centerLng.toFixed(4)}</div>
                            <div>í‰ê·  FRP: ${avgFrp} MW</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ê²€ìƒ‰ ê²°ê³¼ ì—…ë°ì´íŠ¸
        function updateSearchResults(fires, clusters, startDate, endDate) {
            const days = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
            const avgPerDay = fires.length > 0 ? (fires.length / days).toFixed(1) : 0;
            
            document.getElementById('searchPeriod').textContent = `${startDate} ~ ${endDate}`;
            document.getElementById('searchDays').textContent = days;
            document.getElementById('resultTotal').textContent = `${fires.length}ê±´`;
            document.getElementById('resultCluster').textContent = `${clusters.length}ê°œ`;
            document.getElementById('resultAvg').textContent = `${avgPerDay}ê±´/ì¼`;
        }

        // í´ëŸ¬ìŠ¤í„°ë¡œ í¬ì»¤ìŠ¤
        function focusOnCluster(index) {
            if (clusterMarkers[index]) {
                map.setCenter(clusterMarkers[index].getPosition());
                map.setZoom(10);
                
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                }
                
                google.maps.event.trigger(clusterMarkers[index], 'click');
            }
        }

        // ë‚ ì§œ ê²€ìƒ‰ (DBì—ì„œ)
        function handleDateSearch() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (startDate > endDate) {
                alert('ì‹œì‘ ë‚ ì§œê°€ ì¢…ë£Œ ë‚ ì§œë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            loadFireData();
        }

        // ë¹ ë¥¸ ë‚ ì§œ ì„ íƒ
        function setQuickDate(daysAgo) {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - daysAgo);
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            
            handleDateSearch();
        }

        // ì´ˆê¸° ë‚ ì§œ ì„¤ì •
        window.onload = function() {
            const today = new Date();
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        };
    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDMgR74mjlB4MutK1-jqO8gthz-T45jtXg&callback=initMap" async defer></script>
</body>
</html>